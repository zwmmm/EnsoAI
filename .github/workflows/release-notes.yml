name: Release Notes

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to update (e.g. v0.1.6)'
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "name=$TAG" >> $GITHUB_OUTPUT
          # å»æ‰ v å‰ç¼€ä½œä¸ºç‰ˆæœ¬å·
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get Previous Tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ steps.tag.outputs.name }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -1)
          if [ "$PREV_TAG" = "$CURRENT_TAG" ] || [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Get Commits
        id: commits
        run: |
          COMMITS=$(git log ${{ steps.prev_tag.outputs.prev_tag }}..${{ steps.tag.outputs.name }} --pretty=format:"- %s (%h)" --no-merges | head -50)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: generate
        run: |
          TAG="${{ steps.tag.outputs.name }}"
          VERSION="${{ steps.tag.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          COMMITS='${{ steps.commits.outputs.commits }}'

          # è§£æ commits å¹¶åˆ†ç±»
          FEATURES=""
          FIXES=""
          CICD=""
          CHORES=""

          while IFS= read -r line; do
            if [[ -z "$line" ]]; then continue; fi

            # æå– commit messageï¼ˆå»æ‰ hashï¼‰
            MSG=$(echo "$line" | sed 's/ ([a-f0-9]*)$//')

            if [[ "$line" =~ ^-\ feat ]]; then
              # æå–æè¿°éƒ¨åˆ†
              DESC=$(echo "$MSG" | sed 's/^- feat[^:]*: //')
              FEATURES="${FEATURES}- **${DESC}**\n"
            elif [[ "$line" =~ ^-\ fix ]]; then
              DESC=$(echo "$MSG" | sed 's/^- fix[^:]*: //')
              FIXES="${FIXES}- **${DESC}**\n"
            elif [[ "$line" =~ ^-\ ci ]] || [[ "$line" =~ ^-\ build ]]; then
              DESC=$(echo "$MSG" | sed 's/^- \(ci\|build\)[^:]*: //')
              CICD="${CICD}- ${DESC}\n"
            elif [[ "$line" =~ ^-\ chore ]]; then
              # è·³è¿‡ release commit
              if [[ ! "$line" =~ release ]]; then
                DESC=$(echo "$MSG" | sed 's/^- chore[^:]*: //')
                CHORES="${CHORES}- ${DESC}\n"
              fi
            fi
          done <<< "$COMMITS"

          # æ„å»º release notes
          NOTES="## What's Changed\n\n"

          if [[ -n "$FEATURES" ]]; then
            NOTES="${NOTES}### âœ¨ Features\n${FEATURES}\n"
          fi

          if [[ -n "$FIXES" ]]; then
            NOTES="${NOTES}### ğŸ› Bug Fixes\n${FIXES}\n"
          fi

          if [[ -n "$CICD" ]]; then
            NOTES="${NOTES}### ğŸ”¨ CI/CD\n${CICD}\n"
          fi

          if [[ -n "$CHORES" ]]; then
            NOTES="${NOTES}### ğŸ§¹ Chores\n${CHORES}\n"
          fi

          # æ·»åŠ ä¸‹è½½éƒ¨åˆ†
          NOTES="${NOTES}---\n\n"
          NOTES="${NOTES}## ğŸ“¦ ä¸‹è½½\n\n"
          NOTES="${NOTES}| å¹³å° | æ–‡ä»¶ |\n"
          NOTES="${NOTES}|------|------|\n"
          NOTES="${NOTES}| macOS (Apple Silicon) | [EnsoAI-${VERSION}-arm64.dmg](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-${VERSION}-arm64.dmg) |\n"
          NOTES="${NOTES}| macOS (Intel) | [EnsoAI-${VERSION}.dmg](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-${VERSION}.dmg) |\n"
          NOTES="${NOTES}| Windows (x64 å®‰è£…ç‰ˆ) | [EnsoAI-Setup-${VERSION}.exe](https://github.com/${{ github.repository }}/releases/download/${TAG}/EnsoAI-Setup-${VERSION}.exe) |\n\n"
          NOTES="${NOTES}> âš ï¸ **macOS ç”¨æˆ·æ³¨æ„**: ç”±äºåº”ç”¨æœªç­¾åï¼Œé¦–æ¬¡æ‰“å¼€å¯èƒ½æç¤º\"å·²æŸå\"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n"
          NOTES="${NOTES}> \`\`\`bash\n"
          NOTES="${NOTES}> sudo xattr -dr com.apple.quarantine /Applications/EnsoAI.app\n"
          NOTES="${NOTES}> \`\`\`\n\n"
          NOTES="${NOTES}---\n\n"
          NOTES="${NOTES}**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG}"

          # å†™å…¥æ–‡ä»¶
          echo -e "$NOTES" > /tmp/release-notes.md
          cat /tmp/release-notes.md

      - name: Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit ${{ steps.tag.outputs.name }} --notes-file /tmp/release-notes.md
