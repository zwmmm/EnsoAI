name: Update Package Managers

on:
  release:
    types: [published]
  workflow_call:
    inputs:
      tag:
        description: 'Tag name (e.g. v0.1.18)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g. v0.1.18)'
        required: true

permissions:
  contents: read

jobs:
  update-homebrew:
    name: Update Homebrew Cask
    runs-on: macos-latest
    steps:
      - name: Set Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: sleep 60

      - name: Download and calculate SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          echo "Downloading ARM64 DMG..."
          curl -sLO "https://github.com/J3n5en/EnsoAI/releases/download/${TAG}/EnsoAI-${VERSION}-arm64.dmg"
          ARM64_SHA=$(shasum -a 256 "EnsoAI-${VERSION}-arm64.dmg" | cut -d' ' -f1)
          echo "ARM64 SHA256: $ARM64_SHA"

          echo "Downloading x64 DMG..."
          curl -sLO "https://github.com/J3n5en/EnsoAI/releases/download/${TAG}/EnsoAI-${VERSION}.dmg"
          X64_SHA=$(shasum -a 256 "EnsoAI-${VERSION}.dmg" | cut -d' ' -f1)
          echo "x64 SHA256: $X64_SHA"

          echo "arm64=$ARM64_SHA" >> $GITHUB_OUTPUT
          echo "x64=$X64_SHA" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew Tap
        uses: actions/checkout@v4
        with:
          repository: J3n5en/homebrew-ensoai
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update Cask
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARM64_SHA="${{ steps.sha.outputs.arm64 }}"
          X64_SHA="${{ steps.sha.outputs.x64 }}"

          cat > homebrew-tap/Casks/ensoai.rb << 'EOF'
          cask "ensoai" do
            version "VERSION_PLACEHOLDER"
            sha256 arm: "ARM64_SHA_PLACEHOLDER",
                   intel: "X64_SHA_PLACEHOLDER"

            on_arm do
              url "https://github.com/J3n5en/EnsoAI/releases/download/v#{version}/EnsoAI-#{version}-arm64.dmg"
            end
            on_intel do
              url "https://github.com/J3n5en/EnsoAI/releases/download/v#{version}/EnsoAI-#{version}.dmg"
            end

            name "EnsoAI"
            desc "Git Worktree Manager with AI Agent"
            homepage "https://github.com/J3n5en/EnsoAI"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "EnsoAI.app"

            zap trash: [
              "~/Library/Application Support/EnsoAI",
              "~/Library/Preferences/com.ensoai.app.plist",
              "~/Library/Caches/com.ensoai.app",
              "~/Library/Saved Application State/com.ensoai.app.savedState",
            ]
          end
          EOF

          sed -i '' "s/VERSION_PLACEHOLDER/${VERSION}/" homebrew-tap/Casks/ensoai.rb
          sed -i '' "s/ARM64_SHA_PLACEHOLDER/${ARM64_SHA}/" homebrew-tap/Casks/ensoai.rb
          sed -i '' "s/X64_SHA_PLACEHOLDER/${X64_SHA}/" homebrew-tap/Casks/ensoai.rb

      - name: Commit and Push
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/ensoai.rb
          git diff --cached --quiet || git commit -m "Update EnsoAI to ${{ steps.version.outputs.tag }}"
          git push

  update-scoop:
    name: Update Scoop Bucket
    runs-on: ubuntu-latest
    steps:
      - name: Set Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: sleep 60

      - name: Download and calculate SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          echo "Downloading Setup exe..."
          curl -sLO "https://github.com/J3n5en/EnsoAI/releases/download/${TAG}/EnsoAI-Setup-${VERSION}.exe"
          HASH=$(sha256sum "EnsoAI-Setup-${VERSION}.exe" | cut -d' ' -f1)
          echo "SHA256: $HASH"
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Checkout Scoop Bucket
        uses: actions/checkout@v4
        with:
          repository: J3n5en/scoop-ensoai
          token: ${{ secrets.SCOOP_BUCKET_TOKEN }}
          path: scoop-bucket

      - name: Update Manifest
        env:
          VERSION: ${{ steps.version.outputs.version }}
          HASH: ${{ steps.sha.outputs.hash }}
        run: |
          jq -n \
            --arg version "$VERSION" \
            --arg hash "$HASH" \
            '{
              version: $version,
              description: "Git Worktree Manager with AI Agent",
              homepage: "https://github.com/J3n5en/EnsoAI",
              license: "MIT",
              architecture: {
                "64bit": {
                  url: "https://github.com/J3n5en/EnsoAI/releases/download/v\($version)/EnsoAI-Setup-\($version).exe#/setup.exe",
                  hash: $hash
                }
              },
              installer: {
                script: [
                  "Start-Process \"$dir\\setup.exe\" -ArgumentList '"'"'/S'"'"', \"/D=$dir\" -Wait"
                ]
              },
              post_install: [
                "Remove-Item \"$dir\\setup.exe\" -Force"
              ],
              bin: "EnsoAI.exe",
              shortcuts: [
                ["EnsoAI.exe", "EnsoAI"]
              ],
              uninstaller: {
                script: [
                  "Stop-Process -Name '"'"'EnsoAI'"'"' -Force -ErrorAction SilentlyContinue",
                  "Start-Sleep -Seconds 2"
                ]
              },
              checkver: {
                github: "https://github.com/J3n5en/EnsoAI"
              },
              autoupdate: {
                architecture: {
                  "64bit": {
                    url: "https://github.com/J3n5en/EnsoAI/releases/download/v$version/EnsoAI-Setup-$version.exe#/setup.exe"
                  }
                }
              }
            }' > scoop-bucket/bucket/ensoai.json

      - name: Commit and Push
        working-directory: scoop-bucket
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/ensoai.json
          git diff --cached --quiet || git commit -m "Update EnsoAI to ${{ steps.version.outputs.tag }}"
          git push

  update-winget:
    name: Update WinGet
    runs-on: ubuntu-latest
    steps:
      - name: Set Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: sleep 60

      - name: Download and calculate SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          curl -sLO "https://github.com/J3n5en/EnsoAI/releases/download/${TAG}/EnsoAI-Setup-${VERSION}.exe"
          HASH=$(sha256sum "EnsoAI-Setup-${VERSION}.exe" | cut -d' ' -f1 | tr '[:lower:]' '[:upper:]')
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Checkout winget-pkgs fork
        uses: actions/checkout@v4
        with:
          repository: J3n5en/winget-pkgs
          token: ${{ secrets.WINGET_TOKEN }}
          path: winget-pkgs

      - name: Sync fork with upstream
        working-directory: winget-pkgs
        run: |
          git remote add upstream https://github.com/microsoft/winget-pkgs.git || true
          git fetch upstream
          git reset --hard upstream/master

      - name: Create manifest files
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
          HASH: ${{ steps.sha.outputs.hash }}
        run: |
          MANIFEST_DIR="winget-pkgs/manifests/j/J3n5en/EnsoAI/${VERSION}"
          mkdir -p "$MANIFEST_DIR"

          # installer.yaml - explicitly set Architecture: x64 (komac bug workaround)
          cat > "$MANIFEST_DIR/J3n5en.EnsoAI.installer.yaml" << EOF
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.installer.1.12.0.schema.json

          PackageIdentifier: J3n5en.EnsoAI
          PackageVersion: ${VERSION}
          InstallerType: nullsoft
          Scope: user
          InstallModes:
            - interactive
            - silent
            - silentWithProgress
          UpgradeBehavior: install
          Installers:
            - Architecture: x64
              InstallerUrl: https://github.com/J3n5en/EnsoAI/releases/download/${TAG}/EnsoAI-Setup-${VERSION}.exe
              InstallerSha256: ${HASH}
              InstallerSwitches:
                Silent: /S
                SilentWithProgress: /S
          ManifestType: installer
          ManifestVersion: 1.12.0
          EOF

          # locale.yaml
          cat > "$MANIFEST_DIR/J3n5en.EnsoAI.locale.en-US.yaml" << EOF
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.defaultLocale.1.12.0.schema.json

          PackageIdentifier: J3n5en.EnsoAI
          PackageVersion: ${VERSION}
          PackageLocale: en-US
          Publisher: J3n5en
          PublisherUrl: https://github.com/J3n5en
          PublisherSupportUrl: https://github.com/J3n5en/EnsoAI/issues
          Author: EnsoAI Team
          PackageName: EnsoAI
          PackageUrl: https://github.com/J3n5en/EnsoAI
          License: MIT
          LicenseUrl: https://github.com/J3n5en/EnsoAI/blob/main/LICENSE
          ShortDescription: Git Worktree Manager with AI Agent
          Description: EnsoAI is a desktop application that combines Git Worktree management with AI coding agents. It provides a unified workspace where you can manage multiple git worktrees while leveraging AI assistants like Claude, Codex, and Gemini to help with your development tasks.
          Tags:
            - ai
            - claude
            - codex
            - developer-tools
            - electron
            - gemini
            - git
            - git-worktree
            - productivity
            - worktree
          ReleaseNotesUrl: https://github.com/J3n5en/EnsoAI/releases/tag/${TAG}
          ManifestType: defaultLocale
          ManifestVersion: 1.12.0
          EOF

          # version.yaml
          cat > "$MANIFEST_DIR/J3n5en.EnsoAI.yaml" << EOF
          # yaml-language-server: \$schema=https://aka.ms/winget-manifest.version.1.12.0.schema.json

          PackageIdentifier: J3n5en.EnsoAI
          PackageVersion: ${VERSION}
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.12.0
          EOF

          # Remove leading spaces from heredoc
          sed -i 's/^          //' "$MANIFEST_DIR"/*.yaml

      - name: Create branch and commit
        id: branch
        working-directory: winget-pkgs
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="ensoai-${VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add manifests/j/J3n5en/EnsoAI/
          git commit -m "New version: J3n5en.EnsoAI version ${VERSION}"
          git push -u origin "$BRANCH" --force
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="${{ steps.branch.outputs.branch }}"
          gh pr create \
            --repo microsoft/winget-pkgs \
            --head "J3n5en:${BRANCH}" \
            --title "New version: J3n5en.EnsoAI version ${VERSION}" \
            --body "" || echo "PR may already exist"

  update-aur:
    name: Update AUR
    runs-on: ubuntu-latest
    steps:
      - name: Set Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for release assets
        run: sleep 60

      - name: Calculate source tarball SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          echo "Downloading source tarball..."
          curl -sLO "https://github.com/J3n5en/EnsoAI/archive/refs/tags/${TAG}.tar.gz"
          SHA=$(sha256sum "${TAG}.tar.gz" | cut -d' ' -f1)
          echo "SHA256: $SHA"
          echo "sha256=$SHA" >> $GITHUB_OUTPUT

      - name: Generate PKGBUILD
        env:
          PKGVER: ${{ steps.version.outputs.version }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          cat > PKGBUILD << 'PKGBUILD_EOF'
          pkgname=ensoai
          pkgver=PKGVER_PLACEHOLDER
          pkgrel=1
          pkgdesc="Multiple AI Agents, Parallel Workflow - Git worktree manager with AI integration"
          arch=('x86_64')
          url="https://github.com/J3n5en/EnsoAI"
          license=('MIT')
          depends=('electron39')
          makedepends=('nodejs>=20' 'pnpm>=10' 'git' 'libxcrypt-compat')
          optdepends=(
              'claude-cli: Claude AI agent support'
              'codex: Codex AI agent support'
              'cursor: Cursor AI agent support'
          )
          source=("$pkgname-$pkgver.tar.gz::$url/archive/v$pkgver.tar.gz")
          sha256sums=('SHA256_PLACEHOLDER')

          prepare() {
              cd "$srcdir/EnsoAI-$pkgver"
              sed -i '/"name":/a\  "homepage": "https://github.com/J3n5en/EnsoAI",' package.json
              export ELECTRON_SKIP_BINARY_DOWNLOAD=1
              pnpm install --frozen-lockfile
          }

          build() {
              cd "$srcdir/EnsoAI-$pkgver"
              export NODE_ENV=production
              pnpm build:linux
          }

          package() {
              cd "$srcdir/EnsoAI-$pkgver"
              install -dm755 "$pkgdir/usr/lib/$pkgname"
              if [ -d "dist/linux-unpacked/resources" ]; then
                  cp -r dist/linux-unpacked/resources "$pkgdir/usr/lib/$pkgname/"
              fi
              install -dm755 "$pkgdir/usr/bin"
              cat > "$pkgdir/usr/bin/$pkgname" << 'EOF'
          #!/bin/sh
          exec electron39 /usr/lib/ensoai/resources/app.asar "$@"
          EOF
              chmod +x "$pkgdir/usr/bin/$pkgname"
              install -dm755 "$pkgdir/usr/share/applications"
              cat > "$pkgdir/usr/share/applications/$pkgname.desktop" << EOF
          [Desktop Entry]
          Name=EnsoAI
          Comment=Multiple AI Agents, Parallel Workflow
          Exec=$pkgname %U
          Icon=$pkgname
          Type=Application
          Categories=Development;Utility;IDE;
          Terminal=false
          StartupWMClass=EnsoAI
          StartupWMClass=enso-ai
          EOF
              if [ -f "build/icon.png" ]; then
                  install -Dm644 build/icon.png "$pkgdir/usr/share/pixmaps/$pkgname.png"
              elif [ -f "resources/icon.png" ]; then
                  install -Dm644 resources/icon.png "$pkgdir/usr/share/pixmaps/$pkgname.png"
              fi
              install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
          }
          PKGBUILD_EOF
          sed -i 's/^          //' PKGBUILD
          sed -i "s/PKGVER_PLACEHOLDER/${PKGVER}/" PKGBUILD
          sed -i "s/SHA256_PLACEHOLDER/${SHA256}/" PKGBUILD

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: ensoai
          pkgbuild: ./PKGBUILD
          updpkgsums: true
          commit_username: github-actions[bot]
          commit_email: github-actions[bot]@users.noreply.github.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ steps.version.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
